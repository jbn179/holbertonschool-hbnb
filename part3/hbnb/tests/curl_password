#!/bin/bash

# Définir l'URL de base de l'API
API_URL="http://localhost:5000/api/v1"

echo "=== Test d'enregistrement d'utilisateur ==="
USER_RESPONSE=$(curl -s -X POST "$API_URL/users/" \
  -H 'Content-Type: application/json' \
  -d '{
    "first_name": "John",
    "last_name": "Doe",
    "email": "john.doe@example.com",
    "password": "SecurePassword123"
  }')

echo "Réponse d'enregistrement :"
echo "$USER_RESPONSE"

# Extraire l'ID de l'utilisateur nouvellement créé
USER_ID=$(echo $USER_RESPONSE | grep -o '"id":"[^"]*"' | cut -d'"' -f4)

if [ -z "$USER_ID" ]; then
  echo "Erreur: Impossible d'extraire l'ID utilisateur de la réponse"
  exit 1
fi

echo "ID utilisateur: $USER_ID"
echo ""

# Tester le GET par ID utilisateur
echo "=== Test de récupération d'utilisateur par ID ==="
echo "GET $API_URL/users/$USER_ID"
curl -s -X GET "$API_URL/users/$USER_ID" | jq '.'
echo ""

# Vérifier que la réponse ne contient pas de mot de passe
echo "=== Vérification de l'absence de mot de passe dans la réponse ==="
PASSWORD_IN_RESPONSE=$(curl -s -X GET "$API_URL/users/$USER_ID" | grep -o '"password"')
if [ -z "$PASSWORD_IN_RESPONSE" ]; then
  echo "✓ OK: Le mot de passe n'est pas exposé dans la réponse"
else
  echo "✗ ERREUR: Le mot de passe est exposé dans la réponse!"
fi
echo ""

# Tester la liste des utilisateurs
echo "=== Test de récupération de la liste des utilisateurs ==="
echo "GET $API_URL/users/"
curl -s -X GET "$API_URL/users/" | jq '.'
echo ""

# Vérifier que la liste ne contient pas de mots de passe
echo "=== Vérification de l'absence de mots de passe dans la liste ==="
PASSWORD_IN_LIST=$(curl -s -X GET "$API_URL/users/" | grep -o '"password"')
if [ -z "$PASSWORD_IN_LIST" ]; then
  echo "✓ OK: Les mots de passe ne sont pas exposés dans la liste"
else
  echo "✗ ERREUR: Des mots de passe sont exposés dans la liste!"
fi

echo ""
echo "Tests terminés"